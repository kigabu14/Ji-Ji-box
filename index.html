<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≤‡∏¢‡∏Å‡∏•‡πà‡∏≠‡∏á JbBox App | ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∏‡πà‡∏ô ‚Ä¢ ‡∏°‡∏±‡∏î/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‚Ä¢ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏¢‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#22d3ee; --brand2:#0ea5e9; }
    html, body { font-family: 'Prompt', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    .gradient { background: radial-gradient(1000px 600px at 10% -10%, rgba(34,211,238,.25), transparent 60%), radial-gradient(900px 400px at 90% 10%, rgba(14,165,233,.25), transparent 60%), linear-gradient(180deg, #0f172a, #0b1220); }
    .card { background: rgba(2,6,23,.65); border: 1px solid rgba(255,255,255,.08); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .chip { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.08); }
    .kpi { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }
    @media print { .no-print { display: none !important } body { background:#fff } .print-area { background:#fff!important;color:#0b1220!important;border:none!important;box-shadow:none!important } }
    a.link { color:#67e8f9; text-decoration: underline; }
    .mini { font-size:.8rem }
  </style>
</head>
<body class="gradient min-h-screen text-white">
  <header class="max-w-7xl mx-auto px-6 pt-10 pb-6 no-print">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full chip text-xs text-cyan-100">üì¶ ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≤‡∏¢‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ü‡∏π‡∏Å (v3)</div>
        <h1 class="text-3xl md:text-4xl font-semibold mt-3">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Ä¢ ‡∏°‡∏±‡∏î ‚Ä¢ ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‚Ä¢ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß ‚Ä¢ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
        <p class="text-white/70 mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∏‡πà‡∏ô ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡∏ï‡∏¥‡πä‡∏Å ‚Äú‡πÉ‡∏™‡πà‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏±‡∏ô‚Äù ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Google Sheets ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÑ‡∏î‡πâ</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnReset" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <button id="btnPrint" class="px-4 py-2 rounded-xl bg-cyan-400 hover:bg-cyan-300 text-slate-900 font-medium transition">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-6 mt-2">
      <div class="rounded-xl p-3 chip text-xs text-cyan-100">
        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets: ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Apps Script Web App ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Anyone) ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Äù, ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‚Äù, ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PDF‚Äù
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 pb-16">
    <!-- CONFIG + SHEETS -->
    <section class="grid lg:grid-cols-3 gap-6 no-print">
      <div class="card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∏‡πà‡∏ô)</h2>
        <div class="grid md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm text-white/80 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô</label>
            <input id="p_name" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô RSC-403025">
          </div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏¢‡∏≤‡∏ß L (‡∏ã‡∏°.)</label><input id="p_L" type="number" min="5" step="0.1" value="40" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏Å‡∏ß‡πâ‡∏≤‡∏á W (‡∏ã‡∏°.)</label><input id="p_W" type="number" min="5" step="0.1" value="30" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏™‡∏π‡∏á H (‡∏ã‡∏°.)</label><input id="p_H" type="number" min="5" step="0.1" value="25" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏°‡∏±‡∏î (‡πÉ‡∏ö)</label><input id="p_boxesPerBundle" type="number" min="5" step="1" value="20" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÉ‡∏ö (‡∏ö‡∏≤‡∏ó)</label><input id="p_pricePerBox" type="number" min="0" step="0.01" value="12.00" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏°‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)</label><input id="p_pricePerBundle" type="number" min="0" step="0.1" value="220" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div class="md:col-span-2">
            <label class="block text-sm text-white/80 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏∏‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input id="p_note" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°">
          </div>
          <div class="md:col-span-2 flex items-end gap-2">
            <button id="btnAddModel" class="w-full md:w-auto px-4 py-2.5 rounded-xl bg-emerald-400 hover:bg-emerald-300 text-slate-900 font-semibold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∏‡πà‡∏ô</button>
            <button id="btnClearModels" class="w-full md:w-auto px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/20">‡∏•‡∏ö‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold mb-3">‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div id="modelList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>
      </div>

      <div class="card rounded-2xl p-6">
        <h2 class="text-xl font-semibold mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets (‡πÄ‡∏î‡πÇ‡∏°‡πà)</h2>
        <label class="block text-sm text-white/80 mb-1">Web App URL (POST/GET)</label>
        <input id="sheetURL" value='https://script.google.com/macros/s/AKfycbxN7gEpLJFUMcCRxBhT4OjMujuVYF8y2HI3Qh1neZtCU-5uACSsQLJj2Xvzg4cVrew/exec' placeholder="‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec)" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400">
        <label class="block text-sm text-white/80 mb-1 mt-3">Token (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <input id="sheetToken" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400">
        <div class="flex flex-wrap gap-2 mt-4">
          <button id="btnPing" class="px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/20">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
          <button id="btnLoadProducts" class="px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/20">‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="btnSaveProducts" class="px-4 py-2.5 rounded-xl bg-emerald-400 hover:bg-emerald-300 text-slate-900 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="btnSaveOrder" class="px-4 py-2.5 rounded-xl bg-cyan-400 hover:bg-cyan-300 text-slate-900 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
          <button id="btnSavePDF" class="px-4 py-2.5 rounded-xl bg-fuchsia-400 hover:bg-fuchsia-300 text-slate-900 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PDF</button>
        </div>
        <div id="sheetHint" class="text-xs text-white/60 mt-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</div>
      </div>
    </section>

    <!-- ORDER & VEHICLE -->
    <section class="grid lg:grid-cols-3 gap-6 mt-6 no-print">
      <div class="card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-xl font-semibold mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
        <div class="grid md:grid-cols-5 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm text-white/80 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô</label>
            <select id="orderModel" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></select>
          </div>
          <div><label class="block text-sm text-white/80 mb-1">‡∏™‡∏±‡πà‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÉ‡∏ö)</label><input id="orderQty" type="number" min="1" step="1" value="500" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          <div>
            <label class="block text-sm text-white/80 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <select id="orderPriceMode" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400">
              <option value="auto">‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö/‡πÉ‡∏ö vs /‡∏°‡∏±‡∏î)</option>
              <option value="perBox">‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÉ‡∏ö</option>
              <option value="perBundle">‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏°‡∏±‡∏î</option>
            </select>
          </div>
          <div class="flex items-end"><button id="btnAddLine" class="w-full px-4 py-2.5 rounded-xl bg-emerald-400 hover:bg-emerald-300 text-slate-900 font-semibold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
          <div id="orderList" class="space-y-3"></div>
        </div>
      </div>

      <div class="card rounded-2xl p-6">
        <h2 class="text-xl font-semibold mb-4">‡∏Ç‡∏ô‡∏™‡πà‡∏á & ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏°‡∏±‡∏î</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-xs text-white/70 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
            <select id="vehiclePreset" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
              <option value="pickup_box_single">‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö ‡∏ï‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (210√ó160√ó200)</option>
              <option value="pickup_double">‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏™‡∏≠‡∏á‡∏ï‡∏≠‡∏ô (210√ó160√ó175)</option>
              <option value="fourw_jumbo">‡∏™‡∏µ‡πà‡∏•‡πâ‡∏≠‡∏à‡∏±‡∏°‡πÇ‡∏ö‡πâ (310√ó180√ó200)</option>
              <option value="sixw">‡∏´‡∏Å‡∏•‡πâ‡∏≠ (510√ó230√ó240)</option>
            </select>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div><label class="block text-xs text-white/70 mb-1">‡∏¢‡∏≤‡∏ß‡πÇ‡∏´‡∏•‡∏î (‡∏ã‡∏°.)</label><input id="cargoL" type="number" value="210" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
            <div><label class="block text-xs text-white/70 mb-1">‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î (‡∏ã‡∏°.)</label><input id="cargoW" type="number" value="160" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
            <div><label class="block text-xs text-white/70 mb-1">‡∏™‡∏π‡∏á‡πÇ‡∏´‡∏•‡∏î (‡∏ã‡∏°.)</label><input id="cargoH" type="number" value="180" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs text-white/70 mb-1">‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏î‡πâ (‡∏Å‡∏Å.)</label><input id="cargoMaxKg" type="number" value="2000" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
            <div><label class="block text-xs text-white/70 mb-1">‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (%)</label><input id="safetyPct" type="number" value="10" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs text-white/70 mb-1">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏±‡∏î (‡∏ã‡∏°.)</label><input id="gap" type="number" value="0" step="0.5" min="0" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
            <div><label class="block text-xs text-white/70 mb-1">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏ö‡∏≤‡∏ó)</label><input id="shipPerTrip" type="number" value="0" min="0" step="1" class="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
          </div>
          <div class="flex items-center justify-between pt-1">
            <span class="text-white/70 text-sm">‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
            <label class="inline-flex items-center gap-2"><input id="autoRotate" type="checkbox" checked class="w-5 h-5 rounded-md accent-cyan-400"><span class="text-sm">‡πÄ‡∏õ‡∏¥‡∏î</span></label>
          </div>
          <div class="flex items-center justify-between pt-2">
            <span class="text-white/70 text-sm">‡πÉ‡∏™‡πà‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏±‡∏ô (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</span>
            <label class="inline-flex items-center gap-2"><input id="fillToFull" type="checkbox" checked class="w-5 h-5 rounded-md accent-cyan-400"><span class="text-sm">‡πÄ‡∏õ‡∏¥‡∏î</span></label>
          </div>
          <button id="btnCalc" class="w-full mt-2 px-4 py-2.5 rounded-xl bg-cyan-400 hover:bg-cyan-300 text-slate-900 font-semibold">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="mt-8 grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="kpi rounded-2xl p-5"><div class="text-white/70 text-sm">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÉ‡∏ö/‡∏°‡∏±‡∏î)</div><div id="kpiQty" class="text-2xl font-semibold mt-1">-</div><div id="kpiBundles" class="text-white/70 text-sm mt-1">-</div></div>
      <div class="kpi rounded-2xl p-5"><div class="text-white/70 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</div><div id="kpiPrice" class="text-2xl font-semibold mt-1">-</div><div id="kpiShip" class="text-white/70 text-sm mt-1">-</div></div>
      <div class="kpi rounded-2xl p-5"><div class="text-white/70 text-sm">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÉ‡∏ä‡πâ/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div><div id="kpiVol" class="text-2xl font-semibold mt-1">-</div><div id="kpiVolLeft" class="text-white/70 text-sm mt-1">-</div></div>
      <div class="kpi rounded-2xl p-5"><div class="text-white/70 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div><div id="kpiTrips" class="text-2xl font-semibold mt-1">-</div></div>
    </section>

    <!-- TRIP BREAKDOWN -->
    <section class="mt-8 card rounded-2xl p-6">
      <h3 class="text-lg font-semibold mb-3">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</h3>
      <p class="text-white/70 text-sm mb-3">‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡πÉ‡∏ä‡πâ‡∏Å‡∏µ‡πà‡∏•‡∏ö.‡∏°. ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡∏µ‡πà‡∏•‡∏ö.‡∏°. ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°</p>
      <div id="tripBreakdown" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="text-white/60">‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ</div></div>
    </section>

    <!-- VISUAL -->
    <section class="mt-8 card rounded-2xl p-6">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)</h3>
        <div class="flex items-center gap-3 text-sm">
          <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full bg-cyan-400"></span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å</div>
          <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full bg-emerald-400"></span> ‡∏°‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ</div>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-6">
        <div id="bin2D" class="w-full aspect-[16/10] rounded-xl bg-white/5 border border-white/10 grid place-items-center text-white/60 text-sm">‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á</div>
        <div class="space-y-2">
          <div class="p-4 rounded-xl bg-white/5 border border-white/10"><div class="text-sm text-white/70 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô</div><div id="perLayerSummary" class="text-white/90">-</div></div>
          <div class="p-4 rounded-xl bg-white/5 border border-white/10">
            <div class="text-sm text-white/70 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏°‡∏±‡∏î (‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£)</div>
            <div id="bundleSizes" class="text-white/90 text-sm">-</div>
            <p class="text-xs text-white/60 mt-2">‡∏™‡∏π‡∏ï‡∏£: (‡∏Å‡∏ß‡πâ‡∏≤‡∏á+‡∏™‡∏π‡∏á) √ó (‡∏¢‡∏≤‡∏ß+‡∏Å‡∏ß‡πâ‡∏≤‡∏á), ‡∏™‡∏π‡∏á‡∏ï‡πà‡∏≠‡∏°‡∏±‡∏î = 12 ‡∏ã‡∏°.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- QUOTE (PRINT AREA) -->
    <section id="quoteArea" class="mt-8 rounded-2xl p-6 bg-white/5 border border-white/10 print-area">
      <div class="no-print mb-4"><h3 class="text-lg font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3></div>
      <div class="grid md:grid-cols-3 gap-4">
        <div><label class="block text-sm text-white/80 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input id="custName" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
        <div><label class="block text-sm text-white/80 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="custPhone" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
        <div><label class="block text-sm text-white/80 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="custDate" type="date" class="w-full px-4 py-2.5 rounded-xl bg-white/10 border border-white/10 focus:ring-2 focus:ring-cyan-400"></div>
      </div>

      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-sm border-separate border-spacing-y-2">
          <thead class="text-white/80">
            <tr>
              <th class="text-left">‡∏£‡∏∏‡πà‡∏ô</th>
              <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(‡πÉ‡∏ö)</th>
              <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(‡∏°‡∏±‡∏î)</th>
              <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÉ‡∏ö</th>
              <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏°‡∏±‡∏î</th>
              <th class="text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
              <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody id="quoteLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="text-right font-semibold pt-2">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏ß‡∏°</td>
              <td colspan="2" id="quoteShip" class="text-right font-semibold pt-2">-</td>
            </tr>
            <tr>
              <td colspan="5" class="text-right font-semibold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</td>
              <td colspan="2">
                <input id="orderDiscount" type="number" value="0" class="w-32 px-2 py-1 rounded-md bg-white/10 border border-white/20 text-right" />
              </td>
            </tr>
            <tr>
              <td colspan="5" class="text-right font-semibold">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
              <td colspan="2" id="quoteTotal" class="text-right font-semibold">-</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="text-xs text-white/60 mt-3">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á</div>
    </section>

    <!-- APPS SCRIPT HELPER -->
    <section class="mt-10 card rounded-2xl p-6 no-print">
      <h2 class="text-xl font-semibold">‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï Apps Script (Version 3)</h2>
      <p class="text-white/70 text-sm mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ping, get_products, save_order, upsert_products, save_quote_pdf</p>
      <div class="flex items-center justify-between gap-3 mt-3">
        <span class="text-sm text-white/70">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Code.gs</span>
        <button id="btnCopyGS" class="px-4 py-2 rounded-xl bg-cyan-400 hover:bg-cyan-300 text-slate-900 font-semibold">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå</button>
      </div>
      <textarea id="gsCode" class="mt-3 w-full h-[460px] p-4 rounded-xl bg-black/70 border border-white/10 text-cyan-100 text-xs" spellcheck="false">
// ==== Google Apps Script for "Version 3" ====
// ... (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡πà‡∏ß‡∏ô Apps Script) ...
      </textarea>
      <div class="text-white/70 text-xs mt-2">Deploy ‡πÄ‡∏õ‡πá‡∏ô Web app ‚Üí Execute as: Me, Who has access: Anyone, ‡πÄ‡∏≠‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ <b>/exec</b></div>
    </section>
  </main>

  <script>
    // ========== Utils ==========
    const fmtInt = (n)=> (n||0).toLocaleString('th-TH');
    const fmtMoney = (n)=> '‡∏ø' + (n||0).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});
    const nowDate = ()=> new Date().toISOString().slice(0,10);
    const byId = (id)=> document.getElementById(id);
    function pulse(el){ el.style.transition='transform .2s ease'; el.style.transform='scale(1.01)'; setTimeout(()=>el.style.transform='scale(1)',160); }
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function validateWebAppURL(u){ try{ const url=new URL(u); return /script\.google\.com\/macros\/s\/.+\/exec$/.test(url.toString()); }catch{ return false } }

    // ========== Elements ==========
    const modelListEl = byId('modelList');
    const orderModelEl = byId('orderModel');
    const orderQtyEl = byId('orderQty');
    const orderPriceModeEl = byId('orderPriceMode');
    const orderListEl = byId('orderList');
    const bin2D = byId('bin2D');
    const perLayerSummary = byId('perLayerSummary');
    const bundleSizes = byId('bundleSizes');

    const kpiQty = byId('kpiQty');
    const kpiBundles = byId('kpiBundles');
    const kpiPrice = byId('kpiPrice');
    const kpiShip = byId('kpiShip');
    const kpiVol = byId('kpiVol');
    const kpiVolLeft = byId('kpiVolLeft');
    const kpiTrips = byId('kpiTrips');

    const quoteLines = byId('quoteLines');
    const quoteShip = byId('quoteShip');
    const quoteTotal = byId('quoteTotal');

    const cargoLEl = byId('cargoL');
    const cargoWEl = byId('cargoW');
    const cargoHEl = byId('cargoH');
    const safetyPctEl = byId('safetyPct');
    const gapEl = byId('gap');
    const shipPerTripEl = byId('shipPerTrip');
    const autoRotateEl = byId('autoRotate');
    const fillToFullEl = byId('fillToFull');
    const vehiclePresetEl = byId('vehiclePreset');

    const btnAddModel = byId('btnAddModel');
    const btnClearModels = byId('btnClearModels');
    const btnAddLine = byId('btnAddLine');
    const btnCalc = byId('btnCalc');
    const btnPrint = byId('btnPrint');
    const btnReset = byId('btnReset');

    const sheetURL = byId('sheetURL');
    const sheetToken = byId('sheetToken');
    const btnPing = byId('btnPing');
    const btnSaveOrder = byId('btnSaveOrder');
    const btnLoadProducts = byId('btnLoadProducts');
    const btnSaveProducts = byId('btnSaveProducts');
    const btnSavePDF = byId('btnSavePDF');
    const sheetHint = byId('sheetHint');

    const custName = byId('custName');
    const custPhone = byId('custPhone');
    const custDate = byId('custDate');

    const btnCopyGS = byId('btnCopyGS');
    const gsCode = byId('gsCode');

    // ========== Local state ==========
    let models = JSON.parse(localStorage.getItem('box_models')||'[]');
    let orderLines = [];
    let lastSummary = null;

    // ========== Defaults ==========
    custDate.value = nowDate();
    if (models.length===0){
      models = [
        {id: uid(), name:'RSC-403025', L:40, W:30, H:25, boxesPerBundle:20, pricePerBox:12, pricePerBundle:220, note:''},
        {id: uid(), name:'RSC-322218', L:32, W:22, H:18, boxesPerBundle:20, pricePerBox:9.5, pricePerBundle:190, note:''}
      ];
    }

    // ========== Helpers ==========
    function bundleFootprint(model){
      const w = (Number(model.W)||0) + (Number(model.H)||0);
      const l = (Number(model.L)||0) + (Number(model.W)||0);
      const h = 12; // cm
      return {w, l, h};
    }

    // ========== Render ==========
    function renderModels(){
      orderModelEl.innerHTML = models.map(m=>`<option value="${m.id}">${m.name} (${m.L}√ó${m.W}√ó${m.H} ‡∏ã‡∏°.)</option>`).join('');
      modelListEl.innerHTML = models.map(m=>{
        const fp = bundleFootprint(m);
        return `<div class="rounded-xl p-4 bg-white/5 border border-white/10">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold">${m.name}</div>
              <div class="text-white/70 text-sm">‡∏Ç‡∏ô‡∏≤‡∏î/‡πÉ‡∏ö: ${m.L}√ó${m.W}√ó${m.H} ‡∏ã‡∏°.</div>
              <div class="text-white/70 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏°‡∏±‡∏î: ${m.boxesPerBundle} ‡πÉ‡∏ö ‚Ä¢ ‡∏™‡∏π‡∏á/‡∏°‡∏±‡∏î: ${fp.h} ‡∏ã‡∏°.</div>
              <div class="text-white/70 text-sm">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏≤‡∏á‡∏°‡∏±‡∏î: ${(fp.w).toFixed(1)} √ó ${(fp.l).toFixed(1)} ‡∏ã‡∏°.</div>
              <div class="text-white/70 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤: ${fmtMoney(m.pricePerBox)}/‡πÉ‡∏ö ‚Ä¢ ${fmtMoney(m.pricePerBundle)}/‡∏°‡∏±‡∏î</div>
              ${m.note ? `<div class="text-white/50 text-xs mt-1">‡πÇ‡∏ô‡πâ‡∏ï: ${m.note}</div>`:''}
            </div>
            <div class="flex flex-col gap-2">
              <button data-id="${m.id}" class="btnEdit px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button data-id="${m.id}" class="btnDel px-3 py-1.5 rounded-lg bg-red-500/80 hover:bg-red-500 text-sm text-white">‡∏•‡∏ö</button>
            </div>
          </div>
        </div>`;
      }).join('') || `<div class="text-white/60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>`;

      modelListEl.querySelectorAll('.btnDel').forEach(b=>{
        b.onclick = ()=>{ models = models.filter(m=>m.id!==b.dataset.id); saveModels(); renderModels(); };
      });
      modelListEl.querySelectorAll('.btnEdit').forEach(b=>{
        b.onclick = ()=>{
          const m = models.find(x=>x.id===b.dataset.id);
          if (!m) return;
          byId('p_name').value = m.name;
          byId('p_L').value = m.L;
          byId('p_W').value = m.W;
          byId('p_H').value = m.H;
          byId('p_boxesPerBundle').value = m.boxesPerBundle;
          byId('p_pricePerBox').value = m.pricePerBox;
          byId('p_pricePerBundle').value = m.pricePerBundle;
          byId('p_note').value = m.note || '';
          models = models.filter(x=>x.id!==m.id);
          saveModels(); renderModels();
        };
      });
    }
    function saveModels(){ localStorage.setItem('box_models', JSON.stringify(models)); }
    function addModel(){
      const m = {
        id: uid(),
        name: byId('p_name').value || `MODEL-${uid().slice(0,4).toUpperCase()}`,
        L: +byId('p_L').value || 0,
        W: +byId('p_W').value || 0,
        H: +byId('p_H').value || 0,
        boxesPerBundle: Math.max(1, +byId('p_boxesPerBundle').value || 1),
        pricePerBox: Math.max(0, +byId('p_pricePerBox').value || 0),
        pricePerBundle: Math.max(0, +byId('p_pricePerBundle').value || 0),
        note: byId('p_note').value || ''
      };
      models.push(m); saveModels(); renderModels(); pulse(modelListEl);
    }

    // ========== Orders ==========
    function addOrderLine(){
      const id = orderModelEl.value;
      const m = models.find(x=>x.id===id);
      if (!m) return;
      const qty = Math.max(1, +orderQtyEl.value || 1);
      const priceMode = orderPriceModeEl.value;
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á + ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)
      orderLines.push({lineId: uid(), modelId: id, qty, priceMode, sellPricePerBox: 0, discountAmt: 0});
      renderOrder();
    }

    function renderOrder(){
      orderListEl.innerHTML = orderLines.map(l=>{
        const m = models.find(x=>x.id===l.modelId);
        const bundles = Math.ceil(l.qty / m.boxesPerBundle);
        const unitB = m.pricePerBox;
        const unitBundle = m.pricePerBundle;

        // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á/‡πÉ‡∏ö ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ
        const effUnitB = (l.sellPricePerBox && l.sellPricePerBox > 0) ? l.sellPricePerBox : unitB;

        let usedMode = l.priceMode;
        let lineTotal = 0;
        if (l.sellPricePerBox && l.sellPricePerBox > 0) {
          usedMode = 'perBox';
          lineTotal = effUnitB * l.qty;
        } else if (l.priceMode==='auto'){
          const totalByBox = effUnitB * l.qty;
          const totalByBundle = unitBundle * bundles;
          if (totalByBox <= totalByBundle){ usedMode='perBox'; lineTotal=totalByBox; }
          else { usedMode='perBundle'; lineTotal=totalByBundle; }
        } else if (l.priceMode==='perBox'){ lineTotal = effUnitB * l.qty; }
        else { lineTotal = unitBundle * bundles; }

        // ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏ö‡∏≤‡∏ó)
        lineTotal = Math.max(0, lineTotal - (l.discountAmt||0));

        return `
        <div class="rounded-xl p-4 bg-white/5 border border-white/10 flex flex-col gap-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold">${m.name}</div>
              <div class="text-white/70 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${fmtInt(l.qty)} ‡πÉ‡∏ö ‚âà ${fmtInt(bundles)} ‡∏°‡∏±‡∏î ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ä‡πâ: ${usedMode==='perBox'?'‡∏ï‡πà‡∏≠‡πÉ‡∏ö':'‡∏ï‡πà‡∏≠‡∏°‡∏±‡∏î'}</div>
            </div>
            <div class="text-right">
              <div class="text-white/80 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
              <div class="font-semibold">${fmtMoney(lineTotal)}</div>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-2">
            <label class="mini block">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á/‡πÉ‡∏ö (‡∏ö‡∏≤‡∏ó)
              <input data-id="${l.lineId}" data-k="sellPricePerBox" type="number" step="0.01" value="${l.sellPricePerBox||''}" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô"
                class="w-full mt-1 px-3 py-2 rounded-lg bg-white/10 border border-white/15">
            </label>
            <label class="mini block">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)
              <input data-id="${l.lineId}" data-k="discountAmt" type="number" step="0.01" value="${l.discountAmt||0}"
                class="w-full mt-1 px-3 py-2 rounded-lg bg-white/10 border border-white/15">
            </label>
            <div class="mini flex items-end">
              <button data-id="${l.lineId}" class="btnLineDel px-3 py-2 rounded-lg bg-red-500/80 hover:bg-red-500 text-white w-full">‡∏•‡∏ö</button>
            </div>
          </div>
        </div>`;
      }).join('') || `<div class="text-white/60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>`;

      // bind delete
      orderListEl.querySelectorAll('.btnLineDel').forEach(b=>{
        b.onclick=()=>{ orderLines = orderLines.filter(x=>x.lineId!==b.dataset.id); renderOrder(); };
      });

      // bind inline inputs (‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)
      orderListEl.querySelectorAll('input[data-k]').forEach(inp=>{
        inp.oninput = ()=>{
          const id = inp.dataset.id;
          const key = inp.dataset.k;
          const line = orderLines.find(x=>x.lineId===id);
          if (!line) return;
          const val = +inp.value || 0;
          line[key] = val;
          compute();
        };
      });

      compute();
    }

    // ========== Compute (‡∏≠‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà + ‡∏ó‡∏≥ Quote ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á) ==========
    function compute(){
      const gap = Math.max(0, +gapEl.value || 0);
      const autoRotate = autoRotateEl.checked;
      const fillToFull = fillToFullEl.checked;
      const cargoL = +cargoLEl.value, cargoW = +cargoWEl.value, cargoH = +cargoHEl.value;
      const safeH = cargoH * (1 - (+safetyPctEl.value||0)/100);

      let totalQty = 0, totalBundles = 0, subTotal = 0;
      let perModel = [];         // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
      let quoteRows = [];        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤

      if (!orderLines.length){
        quoteLines.innerHTML = '';
        quoteShip.textContent = '-';
        quoteTotal.textContent = '-';
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)
      for (const l of orderLines){
        const m = models.find(x=>x.id===l.modelId); if(!m) continue;
        const bundles = Math.ceil(l.qty / Math.max(1, m.boxesPerBundle));
        totalQty += l.qty; totalBundles += bundles;

        const fp = bundleFootprint(m);

        // ‡∏£‡∏≤‡∏Ñ‡∏≤
        const unitBBase = m.pricePerBox;
        const unitBundle = m.pricePerBundle;
        const unitBSell = (l.sellPricePerBox && l.sellPricePerBox>0)? l.sellPricePerBox : unitBBase;

        let usedMode = l.priceMode;
        let lineTotal = 0;
        if (l.sellPricePerBox && l.sellPricePerBox>0){
          usedMode = 'perBox';
          lineTotal = unitBSell * l.qty;
        } else if (l.priceMode==='auto'){
          const tBox = unitBSell * l.qty;
          const tBundle = unitBundle * bundles;
          if (tBox <= tBundle) { usedMode='perBox'; lineTotal=tBox; }
          else { usedMode='perBundle'; lineTotal=tBundle; }
        } else if (l.priceMode==='perBox'){ lineTotal = unitBSell * l.qty; }
        else { lineTotal = unitBundle * bundles; }

        // ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
        const discountLine = +l.discountAmt || 0;
        lineTotal = Math.max(0, lineTotal - discountLine);

        subTotal += lineTotal;

        perModel.push({ m, qty:l.qty, bundles, usedMode, fp });

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á Quote
        quoteRows.push({
          model: `${m.name}`,
          qtyBox: l.qty,
          bundles: bundles,
          pricePerBox: (usedMode==='perBox') ? unitBSell : 0,
          pricePerBundle: (usedMode==='perBundle') ? unitBundle : 0,
          discount: discountLine,
          lineTotal: lineTotal
        });
      }

      // ====== ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö "‡∏≠‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" : ‡∏ú‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô + ‡πÅ‡∏ö‡πà‡∏á‡πÇ‡∏ã‡∏ô ======
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å footprint ‡∏ó‡∏µ‡πà ‚Äú‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡πà‡∏á‡πÇ‡∏ã‡∏ô‡∏ß‡∏≤‡∏á‡∏ú‡∏™‡∏° (guillotine split) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
      let maxW=0, maxL=0, hPerBundle=12;
      perModel.forEach(x=>{ maxW = Math.max(maxW, x.fp.w); maxL = Math.max(maxL, x.fp.l); });

      function fitSimple(binW, binL, itemW, itemL, gap){
        const cols = Math.max(0, Math.floor( binW / (itemW+gap) ));
        const rows = Math.max(0, Math.floor( binL / (itemL+gap) ));
        return {cols, rows, count: cols*rows};
      }

      function bestLayer(binW, binL, itemW, itemL, gap, allowRotate){
        // 1) ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ‡πÜ 2 ‡∏ó‡∏¥‡∏®
        const A = fitSimple(binW, binL, itemW, itemL, gap);
        const B = fitSimple(binW, binL, itemL, itemW, gap);
        let best = { perLayer:0, cols:A.cols, rows:A.rows, w:itemW, l:itemL, mode:'A' };
        if (B.count > (A.cols*A.rows)) best = { perLayer:B.count, cols:B.cols, rows:B.rows, w:itemL, l:itemW, mode:'B' };
        else best.perLayer = A.cols*A.rows;

        if (!allowRotate) return best;

        // 2) ‡∏ú‡∏™‡∏°‡πÅ‡∏ö‡∏ö "‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á" (‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A + ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô B)
        const colA = Math.floor(binW/(itemW+gap));
        const rowA = Math.floor(binL/(itemL+gap));
        const rowB = Math.floor(binL/(itemW+gap));
        for (let k=0; k<=colA; k++){
          const usedW = k*(itemW+gap);
          const leftW = binW - usedW;
          const colB = Math.max(0, Math.floor(leftW/(itemL+gap)));
          const count = (k*rowA) + (colB*rowB);
          if (count > best.perLayer){
            best = { perLayer:count, cols:k, rows:rowA, w:itemW, l:itemL, mode:'mixW' };
          }
        }

        // 3) ‡∏ú‡∏™‡∏°‡πÅ‡∏ö‡∏ö "‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß" (‡πÅ‡∏ô‡∏ß‡πÅ‡∏ñ‡∏ß A + ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô B)
        const rowA2 = Math.floor(binL/(itemL+gap));
        const colA2 = Math.floor(binW/(itemW+gap));
        const colB2 = Math.floor(binW/(itemL+gap));
        for (let r=0; r<=rowA2; r++){
          const usedL = r*(itemL+gap);
          const leftL = binL - usedL;
          const rowB2 = Math.max(0, Math.floor(leftL/(itemW+gap)));
          const count = (r*colA2) + (rowB2*colB2);
          if (count > best.perLayer){
            best = { perLayer:count, cols:colA2, rows:r, w:itemW, l:itemL, mode:'mixL' };
          }
        }

        return best;
      }

      const chosen = bestLayer(+cargoW, +cargoL, maxW, maxL, gap, autoRotate);
      const layers = Math.max(0, Math.floor( safeH / (hPerBundle + gap) ));
      let maxBundlesPerTrip = chosen.perLayer * layers;

      // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å "‡πÉ‡∏™‡πà‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏±‡∏ô" ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏£‡∏ì‡∏µ gap ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
      if (fillToFull && maxBundlesPerTrip>0){
        const canAddLayer = Math.floor( (safeH + gap) / (hPerBundle + gap) );
        if (canAddLayer > layers){
          maxBundlesPerTrip = chosen.perLayer * canAddLayer;
        }
      }

      // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ footprint ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏°‡∏±‡∏î ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤
      let totalFootArea_cm2 = 0;
      perModel.forEach(x=> totalFootArea_cm2 += x.bundles * (x.fp.w * x.fp.l));
      const avgFootArea_cm2 = totalBundles>0 ? totalFootArea_cm2 / totalBundles : (maxW*maxL);
      const volPerBundle_m3 = (avgFootArea_cm2/10000) * (hPerBundle/100);
      const cargoVolM3 = (cargoL/100)*(cargoW/100)*(safeH/100);

      if (maxBundlesPerTrip <= 0 && totalBundles > 0){
        kpiQty.textContent = `${fmtInt(totalQty)} ‡πÉ‡∏ö`;
        kpiBundles.textContent = `${fmtInt(totalBundles)} ‡∏°‡∏±‡∏î`;
        kpiPrice.textContent = fmtMoney(subTotal);
        kpiShip.textContent  = '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏ß‡∏°: -';
        kpiVol.textContent   = `0.000 / ${cargoVolM3.toFixed(3)} ‡∏•‡∏ö.‡∏°.`;
        kpiVolLeft.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~ ${cargoVolM3.toFixed(3)} ‡∏•‡∏ö.‡∏°.`;
        kpiTrips.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏î‡πâ';
        document.getElementById('tripBreakdown').innerHTML = '<div class="text-white/60">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>';
        perLayerSummary.textContent = '‡∏°‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡πÑ‡∏ã‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ';
        bundleSizes.innerHTML = perModel.length>0 ? perModel.map(x=>`‚Ä¢ ${x.m.name}: ${(x.fp.w).toFixed(1)} √ó ${(x.fp.l).toFixed(1)} √ó 12 ‡∏ã‡∏°. (${fmtInt(x.bundles)} ‡∏°‡∏±‡∏î)`).join('<br>') : '-';
        lastSummary = null;
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Quote ‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        fillQuoteTable(quoteRows, 0, subTotal);
        return;
      }

      // ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
      const tripCards = [];
      let bundlesLeft = totalBundles, tripIndex = 0;
      while (bundlesLeft > 0 && maxBundlesPerTrip>0 && tripIndex < 200){
        tripIndex++;
        const thisTripBundles = Math.min(bundlesLeft, maxBundlesPerTrip);
        const thisTripVol = thisTripBundles * volPerBundle_m3;
        const thisTripVolLeft = Math.max(0, cargoVolM3 - thisTripVol);
        const isFull = thisTripBundles===maxBundlesPerTrip;
        tripCards.push({trip: tripIndex, bundles: thisTripBundles, vol: thisTripVol, volLeft: thisTripVolLeft, full: isFull});
        bundlesLeft -= thisTripBundles;
      }
      const trips = tripCards.length;
      const shipCost = (+shipPerTripEl.value||0) * trips;

      const usedBundlesThisTrip = Math.min(totalBundles, maxBundlesPerTrip);
      const usedVolThisTrip = usedBundlesThisTrip * volPerBundle_m3;
      const volLeftThisTrip = Math.max(0, cargoVolM3 - usedVolThisTrip);

      // KPI
      kpiQty.textContent = `${fmtInt(totalQty)} ‡πÉ‡∏ö`;
      kpiBundles.textContent = `${fmtInt(totalBundles)} ‡∏°‡∏±‡∏î`;
      kpiPrice.textContent = fmtMoney(subTotal);
      kpiShip.textContent = `‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏ß‡∏°: ${fmtMoney(shipCost)} (${fmtInt(trips)} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß √ó ${fmtMoney(+shipPerTripEl.value||0)})`;
      kpiVol.textContent = `${usedVolThisTrip.toFixed(3)} / ${cargoVolM3.toFixed(3)} ‡∏•‡∏ö.‡∏°.`;
      kpiVolLeft.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~ ${volLeftThisTrip.toFixed(3)} ‡∏•‡∏ö.‡∏°.`;
      kpiTrips.textContent = `${fmtInt(trips)} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß`;

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô
      perLayerSummary.textContent = chosen.perLayer>0 ?
        `‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô ~ ${fmtInt(chosen.perLayer)} ‡∏°‡∏±‡∏î √ó ‡∏ã‡πâ‡∏≠‡∏ô ~ ${fmtInt(layers)} ‡∏ä‡∏±‡πâ‡∏ô ‚âà ~ ${fmtInt(maxBundlesPerTrip)} ‡∏°‡∏±‡∏î/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß` :
        '‡∏°‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡πÑ‡∏ã‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ';
      drawPacking(bin2D, cargoW, cargoL, chosen.w, chosen.l, chosen.perLayer, chosen.cols, chosen.rows, gap);

      bundleSizes.innerHTML = perModel.length>0 ? perModel.map(x=>`‚Ä¢ ${x.m.name}: ${(x.fp.w).toFixed(1)} √ó ${(x.fp.l).toFixed(1)} √ó 12 ‡∏ã‡∏°. (${fmtInt(x.bundles)} ‡∏°‡∏±‡∏î)`).join('<br>') : '-';

      // Trip breakdown
      const tripBreakdownEl = document.getElementById('tripBreakdown');
      tripBreakdownEl.innerHTML = tripCards.map(t=>`<div class="rounded-xl p-4 bg-white/5 border border-white/10">
        <div class="font-semibold">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà ${t.trip} ${t.full? '‚Ä¢ ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î ‚úÖ' : `‚Ä¢ ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${t.volLeft.toFixed(3)} ‡∏•‡∏ö.‡∏°.`}</div>
        <div class="text-white/80 text-sm mt-1">‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å ~ ${fmtInt(t.bundles)} ‡∏°‡∏±‡∏î</div>
        <div class="text-white/70 text-sm">‡πÉ‡∏ä‡πâ ~ ${t.vol.toFixed(3)} ‡∏•‡∏ö.‡∏°. ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~ ${t.volLeft.toFixed(3)} ‡∏•‡∏ö.‡∏°.</div>
      </div>`).join('');

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏à‡∏≤‡∏Å "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á"
      fillQuoteTable(quoteRows, shipCost, subTotal);

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏£‡∏∏‡∏õ
      lastSummary = {
        perModel, totalQty, totalBundles,
        totalPrice: subTotal,
        shipCost, trips,
        cargo: { L:cargoL, W:cargoW, H:safeH },
        vol: { cargoVolM3, volPerBundle_m3, usedVolThisTrip, volLeftThisTrip },
        capacityBySpace: maxBundlesPerTrip, maxBundlesPerTrip
      };
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°
    function fillQuoteTable(rows, shipCost, subTotal){
      // render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
      quoteLines.innerHTML = rows.map(r=>{
        return `<tr>
          <td class="text-left">${r.model}</td>
          <td class="text-right">${fmtInt(r.qtyBox)}</td>
          <td class="text-right">${fmtInt(r.bundles)}</td>
          <td class="text-right">${r.pricePerBox? fmtMoney(r.pricePerBox): '-'}</td>
          <td class="text-right">${r.pricePerBundle? fmtMoney(r.pricePerBundle): '-'}</td>
          <td class="text-right">${r.discount? fmtMoney(r.discount): '-'}</td>
          <td class="text-right">${fmtMoney(r.lineTotal)}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="7" class="text-center text-white/60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;

      // ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏ß‡∏°
      quoteShip.textContent = fmtMoney(shipCost||0);

      // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)
      const discEl = byId('orderDiscount');
      const disc = +((discEl && discEl.value) ? discEl.value : 0) || 0;
      discEl && (discEl.oninput = ()=> compute()); // bind ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°

      const grand = Math.max(0, (subTotal||0) + (shipCost||0) - disc);
      quoteTotal.textContent = fmtMoney(grand);
    }

    // ‡∏ß‡∏≤‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô
    function drawPacking(container, binW, binL, itemW, itemL, perLayer, cols, rows, gap){
      container.innerHTML = '';
      container.classList.add('relative');
      const rect = container.getBoundingClientRect();
      const pad = 10;
      const viewW = rect.width - pad*2, viewH = rect.height - pad*2;
      const scale = Math.min(viewW/binW, viewH/binL);

      const bin = document.createElement('div');
      bin.style.position='absolute';
      bin.style.left = (rect.width/2 - (binW*scale)/2) + 'px';
      bin.style.top = (rect.height/2 - (binL*scale)/2) + 'px';
      bin.style.width = (binW*scale) + 'px';
      bin.style.height = (binL*scale) + 'px';
      bin.style.border = '2px solid rgba(34,211,238,0.7)';
      bin.style.borderRadius = '12px';
      bin.style.background = 'rgba(34,211,238,0.10)';
      container.appendChild(bin);

      const cellW = itemW*scale, cellH=itemL*scale, gapPx=gap*scale;
      let placed=0;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(placed>=perLayer) break;
          const d = document.createElement('div');
          d.style.position='absolute';
          d.style.left = (parseFloat(bin.style.left) + c*cellW + gapPx/2) + 'px';
          d.style.top = (parseFloat(bin.style.top) + r*cellH + gapPx/2) + 'px';
          d.style.width = (cellW-gapPx) + 'px';
          d.style.height = (cellH-gapPx) + 'px';
          d.style.borderRadius='8px';
          d.style.background='linear-gradient(135deg, rgba(16,185,129,0.9), rgba(34,197,94,0.9))';
          d.style.boxShadow='0 6px 16px rgba(0,0,0,0.25)';
          container.appendChild(d);
          placed++;
        }
      }

      const label = document.createElement('div');
      label.textContent = `${placed} ‡∏°‡∏±‡∏î/‡∏ä‡∏±‡πâ‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)`;
      label.style.position='absolute';
      label.style.left = bin.style.left;
      label.style.top = `calc(${bin.style.top} - 28px)`;
      label.style.color = '#a5f3fc';
      label.style.fontSize = '14px';
      container.appendChild(label);
    }

    // ========== Events ==========
    btnAddModel.onclick = ()=> addModel();
    btnClearModels.onclick = ()=>{ if(confirm('‡∏•‡∏ö‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ models=[]; saveModels(); renderModels(); } };
    btnAddLine.onclick = ()=> addOrderLine();
    btnCalc.onclick = ()=>{ compute(); pulse(kpiTrips); pulse(bin2D); };
    btnPrint.onclick = ()=> window.print();
    btnReset.onclick = ()=>{ localStorage.removeItem('box_models'); location.reload(); };

    function applyVehiclePreset(key){
      const map = {
        'pickup_box_single': {L:210, W:160, H:200},
        'pickup_double': {L:210, W:160, H:175},
        'fourw_jumbo': {L:310, W:180, H:200},
        'sixw': {L:510, W:230, H:240}
      };
      const v = map[key]; if (!v) return;
      cargoLEl.value = v.L; cargoWEl.value = v.W; cargoHEl.value = v.H;
      compute();
    }
    vehiclePresetEl.onchange = ()=> applyVehiclePreset(vehiclePresetEl.value);

    // ===== Sheets: Ping/Load/Save ‚Äî (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
   

    btnPing.onclick = async ()=>{
      if (!validateWebAppURL(sheetURL.value)) { alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Anyone)'); return; }
      try{
        const url = new URL(sheetURL.value);
        url.searchParams.set('action','ping');
        if (sheetToken.value) url.searchParams.set('token', sheetToken.value);
        const res = await fetch(url.toString(), { mode:'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.ok) { sheetHint.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‚úì (${json.message||'pong'})`; alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); }
        else throw new Error(json.message||'ping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch(e){ console.error(e); sheetHint.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úó'; alert('‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e)); }
    };

    btnLoadProducts.onclick = async ()=>{
      if (!validateWebAppURL(sheetURL.value)) { alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Anyone)'); return; }
      try{
        const url = new URL(sheetURL.value);
        url.searchParams.set('action','get_products');
        if (sheetToken.value) url.searchParams.set('token', sheetToken.value);
        const res = await fetch(url.toString(), { mode:'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (Array.isArray(json.products)){
          models = json.products.map(p=>({ id: uid(), ...p }));
          localStorage.setItem('box_models', JSON.stringify(models));
          renderModels(); sheetHint.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
        } else { throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
      }catch(e){ console.error(e); alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e) + '\n‡∏ï‡∏£‡∏ß‡∏à URL (/exec), ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Anyone, ‡πÅ‡∏•‡∏∞ authorize ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ'); }
    };

    btnSaveProducts.onclick = async ()=>{
      if (!validateWebAppURL(sheetURL.value)) { alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Anyone)'); return; }
      try{
        const payload = {
          action:'upsert_products',
          token: sheetToken.value||'',
          products: models.map(m=>({ name:m.name, L:m.L, W:m.W, H:m.H, boxesPerBundle:m.boxesPerBundle, pricePerBox:m.pricePerBox, pricePerBundle:m.pricePerBundle, note:m.note||'' }))
        };
        const res = await fetch(sheetURL.value, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.ok) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); sheetHint.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'; }
        else throw new Error(json.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(e){ console.error(e); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e)); }
    };

    btnSaveOrder.onclick = async ()=>{
      if (!validateWebAppURL(sheetURL.value)) { alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Anyone)'); return; }
      if (!orderLines.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'); return; }
      const data = {
        token: sheetToken.value||'',
        action: 'save_order',
        customer: { name: custName.value||'', phone: custPhone.value||'', date: custDate.value||nowDate() },
        order: orderLines.map(l=>{
          const m = models.find(x=>x.id===l.modelId);
          return {
            model: m?.name||'',
            size: `${m?.L||0}x${m?.W||0}x${m?.H||0}`,
            qty_box: l.qty,
            per_bundle: m?.boxesPerBundle||0,
            bundles: Math.ceil(l.qty / (m?.boxesPerBundle||1)),
            price_box: (l.sellPricePerBox && l.sellPricePerBox>0)? l.sellPricePerBox : (m?.pricePerBox||0),
            price_bundle: m?.pricePerBundle||0,
            price_mode: l.priceMode
          }
        })
      };
      try{
        const res = await fetch(sheetURL.value, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        alert(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); sheetHint.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      }catch(e){ console.error(e); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e) + '\n‡∏ï‡∏£‡∏ß‡∏à URL (/exec) ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Anyone'); }
    };

    btnSavePDF.onclick = async ()=>{
      if (!validateWebAppURL(sheetURL.value)) { alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Anyone)'); return; }
      if (!lastSummary || !orderLines.length){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏à‡∏≤‡∏Å "quoteRows" ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ PDF ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô
      const rows = Array.from(quoteLines.querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        if (tds.length<7) return null;
        return {
          model: tds[0].innerText,
          qty_box: +tds[1].innerText.replace(/,/g,'')||0,
          bundles: +tds[2].innerText.replace(/,/g,'')||0,
          price_box: tds[3].innerText.startsWith('‡∏ø')? +tds[3].innerText.replace(/[‡∏ø,]/g,''):0,
          price_bundle: tds[4].innerText.startsWith('‡∏ø')? +tds[4].innerText.replace(/[‡∏ø,]/g,''):0,
          discount: tds[5].innerText.startsWith('‡∏ø')? +tds[5].innerText.replace(/[‡∏ø,]/g,''):0,
          line_total: +tds[6].innerText.replace(/[‡∏ø,]/g,'')||0
        }
      }).filter(Boolean);

      const ship = +quoteShip.innerText.replace(/[‡∏ø,]/g,'')||0;
      const grand = +quoteTotal.innerText.replace(/[‡∏ø,]/g,'')||0;

      const payload = {
        action:'save_quote_pdf',
        token: sheetToken.value||'',
        fileName: `QUOTE-${(custName.value||'CUSTOMER')}`,
        customer: { name:custName.value||'', phone:custPhone.value||'', date:custDate.value||nowDate() },
        order: rows,
        totals: {
          shipCost: ship,
          grandTotal: grand,
          trips: lastSummary.trips,
          vehicle: `‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å: ${fmtInt(lastSummary.maxBundlesPerTrip||0)} ‡∏°‡∏±‡∏î/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß`
        }
      };

      try{
        const res = await fetch(sheetURL.value, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.ok && json.url){ sheetHint.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ <a class="link" href="${json.url}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>`; alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); }
        else throw new Error(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(e){ console.error(e); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e) + '\n(‡πÄ‡∏õ‡∏¥‡∏î URL /exec ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠ authorize ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)'); }
    };

    // Copy Apps Script (‡πÄ‡∏î‡∏¥‡∏°)
    btnCopyGS.onclick = async ()=>{
      try{ await navigator.clipboard.writeText(gsCode.value); btnCopyGS.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì'; setTimeout(()=>btnCopyGS.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå',1500);}catch(e){
        gsCode.select(); document.execCommand('copy'); btnCopyGS.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì'; setTimeout(()=>btnCopyGS.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå',1500);
      }
    };

    // Enter = add model
    ['p_name','p_L','p_W','p_H','p_boxesPerBundle','p_pricePerBox','p_pricePerBundle','p_note']
      .forEach(id=> byId(id).addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addModel(); } }));

    // Init
    renderModels(); renderOrder(); compute();
  </script>
</body>
</html>
